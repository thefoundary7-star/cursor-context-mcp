# Vulnerability Check Tool

The `check_vulnerabilities` tool provides comprehensive vulnerability checking across multiple package managers, with structured output and severity filtering for modern development workflows.

## Features

- **Multi-Package Manager Support**: NPM, PIP, Cargo with auto-detection
- **Vulnerability Databases**: Integration with npm audit, pip-audit, cargo audit
- **Severity Filtering**: Filter vulnerabilities by severity level
- **Structured Output**: Normalized vulnerability data across all managers
- **Tool Availability**: Check if vulnerability tools are available
- **Error Handling**: Comprehensive error handling for various scenarios

## Usage

### Basic Vulnerability Check
```json
{
  "method": "tools/call",
  "params": {
    "name": "check_vulnerabilities",
    "arguments": {
      "directory": ".",
      "packageManager": "auto",
      "severity": "medium",
      "includeDevDependencies": true,
      "outputFormat": "json"
    }
  }
}
```

### NPM-Specific Check
```json
{
  "method": "tools/call",
  "params": {
    "name": "check_vulnerabilities",
    "arguments": {
      "directory": ".",
      "packageManager": "npm",
      "severity": "high",
      "includeDevDependencies": true
    }
  }
}
```

## Parameters

### Required Parameters
None - all parameters are optional

### Optional Parameters
- **`directory`** (string): Directory to check (default: ".")
- **`packageManager`** (string): Package manager to use (default: "auto")
- **`severity`** (string): Minimum severity level to report (default: "medium")
- **`includeDevDependencies`** (boolean): Include development dependencies (default: true)
- **`outputFormat`** (string): Output format for results (default: "json")

## Response Format

### Successful Response
```json
{
  "success": true,
  "data": {
    "vulnerabilities": [
      {
        "name": "lodash",
        "version": "4.17.20",
        "severity": "high",
        "advisory": "Prototype pollution vulnerability",
        "source": "npm-audit"
      },
      {
        "name": "axios",
        "version": "0.21.0",
        "severity": "critical",
        "advisory": "Server-Side Request Forgery (SSRF)",
        "source": "npm-audit"
      }
    ],
    "summary": {
      "total": 2,
      "bySeverity": {
        "low": 0,
        "medium": 0,
        "high": 1,
        "critical": 1
      }
    },
    "manager": "npm",
    "directory": "/path/to/directory",
    "timestamp": "2024-01-15T10:30:00.000Z",
    "toolAvailable": true,
    "message": "Vulnerability check completed: 2 vulnerabilities found (1 critical, 1 high, 0 medium, 0 low) using npm"
  }
}
```

### Error Responses

#### Directory Not Found
```json
{
  "success": false,
  "error": "Directory not found",
  "data": {
    "error": "Directory not found",
    "message": "Directory /path/to/directory does not exist",
    "directory": "/path/to/directory"
  }
}
```

#### Vulnerability Checker Not Available
```json
{
  "success": false,
  "error": "Vulnerability checker not available for manager",
  "data": {
    "error": "Vulnerability checker not available for manager",
    "message": "Vulnerability checker npm is not available for npm",
    "directory": "/path/to/directory",
    "manager": "npm",
    "toolName": "npm"
  }
}
```

#### Unsupported Package Manager
```json
{
  "success": false,
  "error": "Vulnerability checker not available for manager",
  "data": {
    "error": "Vulnerability checker not available for manager",
    "message": "Vulnerability checker not available for maven",
    "directory": "/path/to/directory",
    "manager": "maven",
    "supportedManagers": ["npm", "pip", "cargo"]
  }
}
```

#### Not Yet Supported
```json
{
  "success": true,
  "data": {
    "warning": "Vulnerability check not yet supported",
    "message": "Vulnerability checking for maven is not yet supported",
    "directory": "/path/to/directory",
    "manager": "maven",
    "supportedManagers": ["npm", "pip", "cargo"]
  }
}
```

## Package Manager Support

### Supported Package Managers
- **NPM**: Uses `npm audit --json` for Node.js vulnerabilities
- **PIP**: Uses `pip-audit -r requirements.txt --format json` for Python vulnerabilities
- **Cargo**: Uses `cargo audit --json` for Rust vulnerabilities

### Unsupported Package Managers
- **Maven**: Returns warning message (not yet supported)
- **Gradle**: Returns warning message (not yet supported)

## Implementation Details

### NPM Audit Integration
```typescript
async function runNpmAudit(directory: string): Promise<Vulnerability[]> {
  const child = spawn('npm', ['audit', '--json'], {
    cwd: directory,
    stdio: ['pipe', 'pipe', 'pipe'],
    shell: true,
  });
  
  // Parse JSON output for vulnerabilities
  if (auditResult.vulnerabilities) {
    for (const [packageName, vuln] of Object.entries(auditResult.vulnerabilities)) {
      let severity = 'low';
      if (vulnerability.severity === 'critical') severity = 'critical';
      else if (vulnerability.severity === 'high') severity = 'high';
      else if (vulnerability.severity === 'moderate') severity = 'medium';
      
      vulnerabilities.push({
        name: packageName,
        version: vulnerability.version || 'unknown',
        severity,
        advisory: vulnerability.title || vulnerability.description || 'Security vulnerability',
        source: 'npm-audit'
      });
    }
  }
}
```

### PIP Audit Integration
```typescript
async function runPipAudit(directory: string): Promise<Vulnerability[]> {
  const child = spawn('pip-audit', ['-r', 'requirements.txt', '--format', 'json'], {
    cwd: directory,
    stdio: ['pipe', 'pipe', 'pipe'],
    shell: true,
  });
  
  // Parse JSON output for vulnerabilities
  if (auditResult.vulnerabilities) {
    for (const vuln of auditResult.vulnerabilities) {
      let severity = 'low';
      if (vuln.severity === 'CRITICAL') severity = 'critical';
      else if (vuln.severity === 'HIGH') severity = 'high';
      else if (vuln.severity === 'MEDIUM') severity = 'medium';
      
      vulnerabilities.push({
        name: vuln.package || vuln.name || 'unknown',
        version: vuln.version || 'unknown',
        severity,
        advisory: vuln.description || vuln.advisory || 'Security vulnerability',
        source: 'pip-audit'
      });
    }
  }
}
```

### Cargo Audit Integration
```typescript
async function runCargoAudit(directory: string): Promise<Vulnerability[]> {
  const child = spawn('cargo', ['audit', '--json'], {
    cwd: directory,
    stdio: ['pipe', 'pipe', 'pipe'],
    shell: true,
  });
  
  // Parse JSON output for vulnerabilities
  if (auditResult.vulnerabilities) {
    for (const vuln of auditResult.vulnerabilities) {
      let severity = 'low';
      if (vuln.severity === 'critical') severity = 'critical';
      else if (vuln.severity === 'high') severity = 'high';
      else if (vuln.severity === 'medium') severity = 'medium';
      
      vulnerabilities.push({
        name: vuln.package || vuln.name || 'unknown',
        version: vuln.version || 'unknown',
        severity,
        advisory: vuln.description || vuln.advisory || 'Security vulnerability',
        source: 'cargo-audit'
      });
    }
  }
}
```

### Tool Availability Check
```typescript
async function checkToolAvailability(tool: string): Promise<boolean> {
  const child = spawn(tool, ['--version'], {
    stdio: ['pipe', 'pipe', 'pipe'],
    shell: true,
  });
  
  child.on('close', (code) => {
    resolve(code === 0);
  });
  
  child.on('error', () => {
    resolve(false);
  });
}
```

## Examples

### Auto-Detection
```json
{
  "name": "check_vulnerabilities",
  "arguments": {
    "directory": "."
  }
}
```

### NPM Check
```json
{
  "name": "check_vulnerabilities",
  "arguments": {
    "directory": ".",
    "packageManager": "npm",
    "severity": "high",
    "includeDevDependencies": true
  }
}
```

### Python Check
```json
{
  "name": "check_vulnerabilities",
  "arguments": {
    "directory": ".",
    "packageManager": "pip",
    "severity": "medium",
    "includeDevDependencies": false
  }
}
```

### Rust Check
```json
{
  "name": "check_vulnerabilities",
  "arguments": {
    "directory": ".",
    "packageManager": "cargo",
    "severity": "critical",
    "includeDevDependencies": true
  }
}
```

### High Severity Only
```json
{
  "name": "check_vulnerabilities",
  "arguments": {
    "directory": ".",
    "severity": "high",
    "outputFormat": "summary"
  }
}
```

## Use Cases

### Security Auditing
- **Vulnerability Scanning**: Identify known security vulnerabilities
- **Severity Assessment**: Prioritize vulnerabilities by severity
- **Dependency Security**: Check security of project dependencies
- **Compliance**: Meet security compliance requirements

### Development Workflow
- **Pre-commit Hooks**: Check vulnerabilities before commits
- **CI/CD Integration**: Automated vulnerability checking in pipelines
- **Code Review**: Security review of dependencies
- **Risk Assessment**: Evaluate security risks in dependencies

### Production Readiness
- **Deployment Checks**: Verify security before deployment
- **Vulnerability Management**: Track and remediate security issues
- **Security Monitoring**: Continuous vulnerability monitoring
- **Audit Trail**: Maintain vulnerability audit history

## Error Handling

### Common Error Scenarios
- **Directory Not Found**: Invalid directory path
- **Tool Not Available**: Missing vulnerability checker tools
- **Unsupported Manager**: Package manager not supported
- **Parse Errors**: Malformed vulnerability data
- **Timeout**: Long-running operations exceeding limits

### Error Recovery
- **Graceful Degradation**: Continue with available information
- **Partial Results**: Return results from successful checks
- **Error Reporting**: Detailed error messages for troubleshooting
- **Fallback Behavior**: Skip problematic checks and continue

## Performance Considerations

### Optimization Strategies
- **Tool Availability**: Check tool availability before execution
- **Timeout Management**: Prevent hanging processes
- **Efficient Parsing**: Use optimized parsing algorithms
- **Caching**: Cache vulnerability results where possible

### Best Practices
```json
// For quick vulnerability checks
{
  "name": "check_vulnerabilities",
  "arguments": {
    "severity": "high",
    "includeDevDependencies": false
  }
}

// For comprehensive analysis
{
  "name": "check_vulnerabilities",
  "arguments": {
    "severity": "low",
    "includeDevDependencies": true
  }
}
```

## Integration with Other Tools

### With Security Audit
```javascript
// Get vulnerability information
const vulnerabilities = await handleSecurityTool('check_vulnerabilities', {
  directory: '.',
  packageManager: 'npm',
  severity: 'medium'
});

// Then run comprehensive security audit
const audit = await handleSecurityTool('security_audit', {
  directory: '.',
  severity: 'medium'
});
```

### With Dependency Analysis
```javascript
// Get dependency information
const dependencies = await handleSecurityTool('analyze_dependencies', {
  directory: '.',
  packageManager: 'auto'
});

// Then check for vulnerabilities
const vulnerabilities = await handleSecurityTool('check_vulnerabilities', {
  directory: '.',
  packageManager: dependencies.data.manager,
  severity: 'high'
});
```

## Limitations

### Current Limitations
- **Tool Dependency**: Requires external vulnerability checker tools
- **Limited Support**: Only supports npm, pip, and cargo
- **No Real-time**: Doesn't provide real-time vulnerability updates
- **Basic Parsing**: Simple parsing without advanced features

### Future Enhancements
- **Multi-Source**: Integration with multiple vulnerability databases
- **Real-time Updates**: Live vulnerability data
- **Advanced Filtering**: More sophisticated filtering options
- **Remediation**: Automated vulnerability remediation
- **Reporting**: Advanced vulnerability reporting

## Troubleshooting

### Common Issues
1. **Tool Not Found**: Ensure vulnerability checker tools are installed
2. **Permission Denied**: Check file system permissions
3. **Parse Errors**: Verify vulnerability data format
4. **Timeout**: Large projects may require longer timeouts

### Debug Mode
Enable debug logging for detailed troubleshooting:
```json
{
  "name": "check_vulnerabilities",
  "arguments": {
    "directory": ".",
    "debug": true
  }
}
```

## Support and Documentation

### Additional Resources
- **Vulnerability Databases**: CVE, NVD, OWASP resources
- **Security Best Practices**: Industry security guidelines
- **Tool Documentation**: Official documentation for vulnerability checkers
- **Compliance Guides**: Regulatory compliance documentation

### Community Support
- **GitHub Issues**: Report bugs and feature requests
- **Documentation**: Comprehensive tool documentation
- **Examples**: Usage examples and best practices
- **Contributions**: Community contributions and improvements
